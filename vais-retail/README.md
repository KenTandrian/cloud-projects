# Vertex AI Search for Commerce: Investment Broker Demo

This repository contains a complete demonstration project for showcasing the capabilities of Google Cloud's Vertex AI Search for Commerce (formerly Retail API). The demo is tailored for a financial services use case, specifically providing AI-powered search and recommendations for an investment brokerage.

Instead of a typical e-commerce catalog of products, this demo uses a catalog of US stocks. Instead of shopper behavior, it simulates the actions of different investor personas.

## Project Structure & Key Files

The project is organized into functional directories:

- **`data/`**: Contains the generated `.json` data files for products and user events.
- **`generators/`**: Scripts responsible for creating the local data files.
- **`schemas/`**: The JSON schemas that define the structure for the product and user event data.
- **`scripts/`**: The core workflow scripts, organized by execution phase.
- **`setup_cleanup.py`**: A **utility library** of helper functions for interacting with Google Cloud APIs (GCS, Retail). This file is **imported by other scripts** in the workflow; it is not meant to be executed directly.
- **`user_environment_setup.sh`**: The main setup script for initializing the environment and configuring cloud permissions.
- **`key.json`**: This file is **generated by the setup script** and stored in your home directory (`~/key.json`).

## Setup & Installation

### Prerequisites

1.  [Google Cloud SDK (gcloud CLI)](https://cloud.google.com/sdk/docs/install) is installed on your machine.
2.  You are authenticated with the gcloud CLI (`gcloud auth login`).
3.  You have a Google Cloud Project with the **Retail API** enabled.

### Running the Setup Script

The `user_environment_setup.sh` script automates the entire setup process.

1.  **Execute the script from the project root**, passing your Google Cloud Project ID as an argument:

    ```bash
    source ./user_environment_setup.sh <YOUR_PROJECT_ID>
    ```

    Replace `<YOUR_PROJECT_ID>` with your actual GCP Project ID.

2.  **What the Script Does:**
    - Sets your `gcloud` configuration to use the specified project.
    - Checks for, or creates, a service account named `vais-retail-01`.
    - Assigns the necessary `Editor` and `Retail Admin` roles to this service account.
    - **Creates a service account key** named `key.json` and saves it to your **home directory (`~`)**. It will overwrite any existing file at `~/key.json`.
    - Activates this service account, so all subsequent `gcloud` and client library commands are authenticated correctly.
    - It also creates a Python virtual environment (`.venv`) and installs the packages from `requirements.txt`.

## Execution Workflow

Follow these steps in order to run the complete demo.

### Step 1: Generate Local Data

First, you need to generate the JSON data files for products (stocks) and user events.

```bash
# Generate the products.json file
python generators/generate_products.py

# Generate the user_events.json file
python generators/generate_user_event.py
```

### Step 2: Prepare Cloud Environment & Import Data

These scripts use functions from `setup_cleanup.py` to create a GCS bucket, upload your data, and begin the import process into Vertex AI Search.

```bash
# 1. Create the GCS bucket
python scripts/1_data_preparation/products_create_gcs_bucket.py

# 2. Upload and import the products catalog
python scripts/1_data_preparation/import_products_gcs.py

# 3. Upload and import the user events
python scripts/1_data_preparation/upload_import_user_events_gcs.py
```

_Wait for the import jobs to complete in the Google Cloud Console before proceeding._

### Step 3: Create and Train Recommendation Models

Run these scripts to start the training jobs for the three recommendation models.

```bash
python scripts/2_model_management/create_oyml_model.py
python scripts/2_model_management/create_rfy_model.py
python scripts/2_model_management/create_fbt_model.py
```

**Important:** Model training can take **2-4 hours**. You can monitor the status in the Google Cloud Console under "Vertex AI Search for retail" > "Models".

### Step 4: Run Search & Recommendation Queries

Once the models are active, you can query the service.

```bash
# Run a search query with dynamic boosting
# (You can edit the query and boost conditions inside the script)
python scripts/3_serving/search_with_boost_spec.py
```

### Step 5: Cleanup

To avoid incurring ongoing costs, you must manually delete the resources created during the demo.

1.  **Delete Recommendation Models:**

    - Go to the Google Cloud Console > Vertex AI Search for retail > Models.
    - Select and delete each of the models.

2.  **Delete GCS Bucket:**
    - Go to the Google Cloud Console > Cloud Storage > Buckets.
    - Find the bucket created by the scripts.
    - Select the bucket and click "Delete". You will need to type the bucket name to confirm.
